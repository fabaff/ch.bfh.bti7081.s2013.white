package ch.bfh.ti.soed.white.mhc_pms.ui;

import ch.bfh.ti.soed.white.mhc_pms.controller.EditEvent;
import ch.bfh.ti.soed.white.mhc_pms.controller.PmsComponentController;
import ch.bfh.ti.soed.white.mhc_pms.data.PCase;
import ch.bfh.ti.soed.white.mhc_pms.data.PmsDataAccess;
import ch.bfh.ti.soed.white.mhc_pms.data.enums.KindOfTreatment;
import ch.bfh.ti.soed.white.mhc_pms.data.enums.OrderOfPatient;
import ch.bfh.ti.soed.white.mhc_pms.data.enums.ReanimationStatus;

import com.vaadin.addon.jpacontainer.EntityItem;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.fieldgroup.FieldGroup;
import com.vaadin.data.fieldgroup.FieldGroup.CommitException;
import com.vaadin.data.util.BeanItem;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.TextField;

public class EditCaseInfoComponent extends PmsComponentController {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private AbsoluteLayout mainLayout;
	@AutoGenerated
	private ComboBox cmbKindOfTreatment;
	@AutoGenerated
	private TextField txtSuicidalTendency;
	@AutoGenerated
	private ComboBox cmbOrderOfPatient;
	@AutoGenerated
	private TextField txtSanction;
	@AutoGenerated
	private TextField txtJudicialStatus;
	@AutoGenerated
	private TextField txtVacation;
	@AutoGenerated
	private TextField txtGoOutStatus;
	@AutoGenerated
	private TextField txtDegreeOfDanger;
	@AutoGenerated
	private TextField txtAssignment;
	@AutoGenerated
	private ComboBox cmbReanimationStatus;
	@AutoGenerated
	private Button btnCancel;
	@AutoGenerated
	private Button btnSave;
	private static final long serialVersionUID = 7804702033977054145L;

	private PmsDataAccess dataAccess;

	private FieldGroup fieldGroup;

	private BeanItem<PCase> newPatientItem;

	/**
	 * The constructor should first build the main layout, set the composition
	 * root and then do any custom initialization.
	 * 
	 * The constructor will not be automatically regenerated by the visual
	 * editor.
	 */
	public EditCaseInfoComponent() {
		buildMainLayout();
		setCompositionRoot(mainLayout);

		this.dataAccess = PmsDataAccess.getInstance();
		this.dataAccess.getPCaseContainer().refresh();
		this.fieldGroup = new FieldGroup();

		this.cmbKindOfTreatment.addItem(KindOfTreatment.Stationär);
		this.cmbKindOfTreatment.addItem(KindOfTreatment.Teilstationär);
		this.cmbKindOfTreatment.addItem(KindOfTreatment.Ambulant);
		this.cmbOrderOfPatient.addItem(OrderOfPatient.Nein);
		this.cmbOrderOfPatient.addItem(OrderOfPatient.Ja);
		this.cmbReanimationStatus.addItem(ReanimationStatus.Ja);
		this.cmbReanimationStatus.addItem(ReanimationStatus.Eingeschränkt);
		this.cmbReanimationStatus.addItem(ReanimationStatus.Nein);

		this.bindFields();
		this.addListeners();

	}

	private void bindFields() {
		// TODO bessere Trennung Model und View
		EntityItem<PCase> item = this.dataAccess.getPCaseContainer().getItem(
				this.dataAccess.getCurrentPCaseId());
		
		if (item != null) {
			this.fieldGroup.setItemDataSource(item);
			this.fieldGroup.bind(this.cmbReanimationStatus, "reanimationStatus");
			
		}
	}

	private void addListeners() {
		this.btnSave.addClickListener(new Button.ClickListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void buttonClick(ClickEvent event) {
				try {
					EditCaseInfoComponent.this.fieldGroup.commit();
				} catch (CommitException e) {
					// TODO Exception Handling
					e.printStackTrace();
				}

				// TODO bessere Trennung Model und View
				if (!EditCaseInfoComponent.this.dataAccess.isNewCaseActivated()) {
					EditCaseInfoComponent.this.dataAccess.getPCaseContainer().removeItem(EditCaseInfoComponent.this.dataAccess.getCurrentPCaseId());
				}
				
				Object id = EditCaseInfoComponent.this.dataAccess.getPCaseContainer().addEntity(
						EditCaseInfoComponent.this.newPatientItem.getBean());
				dataAccess.getPCaseContainer().commit();
				dataAccess.getPCaseContainer().refresh();
				EditCaseInfoComponent.this.dataAccess.setCurrentPCaseId(id);

				EditCaseInfoComponent.this.bindFields();
				EditCaseInfoComponent.this.fireUIActivationEvent(true);
				EditCaseInfoComponent.this
						.fireComponentChangeEvent(EditEvent.PCASE_BACK);
				EditCaseInfoComponent.this.firePCaseItemChangeEvent(id);
			}
		});

		this.btnCancel.addClickListener(new Button.ClickListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void buttonClick(ClickEvent event) {
				EditCaseInfoComponent.this.fieldGroup.discard();
				EditCaseInfoComponent.this.fireUIActivationEvent(true);
				EditCaseInfoComponent.this
						.fireComponentChangeEvent(EditEvent.PCASE_BACK);
			}
		});
	}

	@AutoGenerated
	private AbsoluteLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new AbsoluteLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// btnSave
		btnSave = new Button();
		btnSave.setCaption("Speichern");
		btnSave.setImmediate(true);
		btnSave.setWidth("80px");
		btnSave.setHeight("-1px");
		mainLayout.addComponent(btnSave, "top:220.0px;left:20.0px;");
		
		// btnCancel
		btnCancel = new Button();
		btnCancel.setCaption("Abbrechen");
		btnCancel.setImmediate(true);
		btnCancel.setWidth("-1px");
		btnCancel.setHeight("-1px");
		mainLayout.addComponent(btnCancel, "top:220.0px;left:120.0px;");
		
		// cmbReanimationStatus
		cmbReanimationStatus = new ComboBox();
		cmbReanimationStatus.setCaption("Reanimationsstatus: ");
		cmbReanimationStatus.setImmediate(false);
		cmbReanimationStatus.setWidth("-1px");
		cmbReanimationStatus.setHeight("-1px");
		mainLayout
				.addComponent(cmbReanimationStatus, "top:40.0px;left:20.0px;");
		
		// txtAssignment
		txtAssignment = new TextField();
		txtAssignment.setCaption("Zuweiser: ");
		txtAssignment.setImmediate(false);
		txtAssignment.setWidth("-1px");
		txtAssignment.setHeight("-1px");
		mainLayout.addComponent(txtAssignment, "top:40.0px;left:220.0px;");
		
		// txtDegreeOfDanger
		txtDegreeOfDanger = new TextField();
		txtDegreeOfDanger.setCaption("Fremdgefährtung: ");
		txtDegreeOfDanger.setImmediate(false);
		txtDegreeOfDanger.setWidth("-1px");
		txtDegreeOfDanger.setHeight("-1px");
		mainLayout.addComponent(txtDegreeOfDanger, "top:40.0px;left:600.0px;");
		
		// txtGoOutStatus
		txtGoOutStatus = new TextField();
		txtGoOutStatus.setCaption("Ausgang: ");
		txtGoOutStatus.setImmediate(false);
		txtGoOutStatus.setWidth("-1px");
		txtGoOutStatus.setHeight("-1px");
		mainLayout.addComponent(txtGoOutStatus, "top:100.0px;left:20.0px;");
		
		// txtVacation
		txtVacation = new TextField();
		txtVacation.setCaption("Urlaub: ");
		txtVacation.setImmediate(false);
		txtVacation.setWidth("-1px");
		txtVacation.setHeight("-1px");
		mainLayout.addComponent(txtVacation, "top:100.0px;left:220.0px;");
		
		// txtJudicialStatus
		txtJudicialStatus = new TextField();
		txtJudicialStatus.setCaption("Juristischer CaseStatus: ");
		txtJudicialStatus.setImmediate(false);
		txtJudicialStatus.setWidth("-1px");
		txtJudicialStatus.setHeight("-1px");
		mainLayout.addComponent(txtJudicialStatus, "top:100.0px;left:400.0px;");
		
		// txtSanction
		txtSanction = new TextField();
		txtSanction.setCaption("Zwangsmassnahmen: ");
		txtSanction.setImmediate(false);
		txtSanction.setWidth("-1px");
		txtSanction.setHeight("-1px");
		mainLayout.addComponent(txtSanction, "top:100.0px;left:600.0px;");
		
		// cmbOrderOfPatient
		cmbOrderOfPatient = new ComboBox();
		cmbOrderOfPatient.setCaption("Patientenverfügung vorhanden: ");
		cmbOrderOfPatient.setImmediate(false);
		cmbOrderOfPatient.setWidth("-1px");
		cmbOrderOfPatient.setHeight("-1px");
		mainLayout.addComponent(cmbOrderOfPatient, "top:160.0px;left:20.0px;");
		
		// txtSuicidalTendency
		txtSuicidalTendency = new TextField();
		txtSuicidalTendency.setCaption("Suizidalität: ");
		txtSuicidalTendency.setImmediate(false);
		txtSuicidalTendency.setWidth("-1px");
		txtSuicidalTendency.setHeight("-1px");
		mainLayout
				.addComponent(txtSuicidalTendency, "top:40.0px;left:399.0px;");
		
		// cmbKindOfTreatment
		cmbKindOfTreatment = new ComboBox();
		cmbKindOfTreatment.setCaption("Behandlungsart: ");
		cmbKindOfTreatment.setImmediate(false);
		cmbKindOfTreatment.setWidth("-1px");
		cmbKindOfTreatment.setHeight("-1px");
		mainLayout
				.addComponent(cmbKindOfTreatment, "top:160.0px;left:220.0px;");
		
		return mainLayout;
	}

}
